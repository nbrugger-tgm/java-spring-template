plugins {
    id 'org.sonarqube' version '3.3'//used to report issues to sonarqube
    id 'com.bmuschko.docker-remote-api' version '7.1.0'//used to build and push docker images
}

//configure subprojects
allprojects {
    apply from: "${rootDir}/modules/config.gradle"
    version = '0.5.0b10'
    group = project.ext.rootPackage
}
ext.modules = subprojects
        .stream()
        .filter { it.projectDir.absolutePath.startsWith("${rootProject.projectDir.absolutePath}${File.separatorChar}modules") }
        .toSet()
println "ext.modules: ${ext.modules}"
apply from: "${rootDir}/modules/deployment.gradle"
subprojects {
    if (!name.equals("client"))
        apply from: "${rootDir}/modules/submodule.gradle"
}

sonarqube {
    properties {
        property 'sonar.projectName', project.ext.displayName
        property "sonar.sourceEncoding", "UTF-8"
        property "sonar.projectKey", project.ext.sonarProjectKey
        property "sonar.organization", project.ext.sonarOrganization
        property "sonar.host.url", project.ext.sonarHost
        property "sonar.tests", "src/intTest,src/archTest,src/test,src/*Test"
        property "sonar.coverage.exclusions", "**/controllers/**/*.*, **/entities/**/*.*, **/models/**/*.*"
        property "sonar.exclusions", "**/client/java/**/*.*"//java client is automatically generated
    }
}

project("client") {
    afterEvaluate {
        publishing {
            repositories {
                maven {
                    name = "Artifactory"
                    url = project.ext.mvnRepoUrl
                    credentials {
                        username = project.ext.mvnRepoUser
                        password = System.getenv(project.ext.mvnRepoEnvKey)
                    }
                }
            }
        }
    }
}